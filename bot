import vk_api
from vk_api.longpoll import VkLongPoll, VkEventType
from vk_api.bot_longpoll import VkBotLongPoll, VkBotEventType
import requests
import sqlite3

myid = -201978017
need_to_activate = False

answers = {'–ø—Ä–∏–≤–µ—Ç' : '–Ω—É –ø—Ä–∏–≤–µ—Ç',
           '–ø–æ–∫–∞' : '–∞ —Ç—ã –∫—É–¥–∞?',
           '–∫–∞–∫ –¥–µ–ª–∞?' : '–æ—Ç–ª–∏—á–Ω–æ, –∫–∞–∫ —Å–∞–º?'}

commands = ['kick', '–∫–∏–∫', 'ban', '–±–∞–Ω', 'mute', '–º—É—Ç', 'warn', '–≤–∞—Ä–Ω', 'help', '—Ö–µ–ª–ø', '–∏–Ω—Ñ–æ', 'info', 'myid', '–º–æ–π–∏–¥']


# –§—É–Ω–∫—Ü–∏—è –ø–æ—Å—ã–ª–∞—é—â–∞—è —Å–æ–æ–±—â–µ–Ω–∏–µ
def write_msg(peer_id, message):
    random_id = vk_api.utils.get_random_id()
    vk.method('messages.send', {'peer_id': peer_id, 'message': message, 'random_id': random_id})


# –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è –∫–∞–∫ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ
vk = vk_api.VkApi(token="15a4c8cc3ceaa121d1afc5032f40846ef7f01b1655f97560950e5535986e165cb49d472b72c9ede63a1be")
#longpoll = VkLongPoll(vk)
bot_api = vk.get_api()
otvet = ''

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
while True:
    longpoll = VkBotLongPoll(vk, 201978017)
    try:
        for event in longpoll.listen():
            # –ï—Å–ª–∏ –ø—Ä–∏—à–ª–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            # print(event.type)
            # print([*event.object])
            print(event)
            if event.object.text == '':
                action = event.object.action
                if action['type'] == 'chat_kick_user':
                    name = bot_api.users.get(user_id=action["member_id"])
                    otvet = f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @id{event.object.from_id}({name[0]["first_name"]} {name[0]["last_name"]}) –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç'
                elif action['type'] == 'chat_invite_user':
                    if action['member_id'] == myid:
                        con = sqlite3.connect('chats.sqlite')
                        cur = con.cursor()
                        values = cur.execute("""SELECT id FROM chats""").fetchall()
                        print(values)
                        con.commit()
                        con.close()
                        ids = list()
                        for elem in values:
                            ids.append(elem[0])
                        print(ids)
                        if event.object.peer_id in ids:
                            otvet = f'–Ø —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ –¥–∞–Ω–Ω–æ–π –±–µ—Å–µ–¥–µ(id = {event.object.peer_id}) –∏ –º–æ–≥—É –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É! ;)'
                        else:
                            otvet = f'–ü—Ä–∏–≤–µ—Ç! –í—ã –¥–æ–±–∞–≤–∏–ª–∏ –º–µ–Ω—è –≤ —Å–≤–æ–π —á–∞—Ç :) \n' \
                                    f'–ù–µ –±–æ–π—Ç–µ—Å—å, —è –Ω–µ –∫—É—Å–∞—é—Å—å, –∞ —Ç–∞–∫–∂–µ, –Ω–µ —á–∏—Ç–∞—é –í–∞—à–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏.\n' \
                                    f'–Ø —Ä–µ–∞–≥–∏—Ä—É—é —Ç–æ–ª—å–∫–æ –Ω–∞ –∫–æ–º–∞–Ω–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑–∞–Ω—ã –≤ /help.\n' \
                                    f'–ß—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–µ–Ω—è - –¥–æ–±–∞–≤—å—Ç–µ –≤ –±–µ—Å–µ–¥—É @fedya_nelubin(–º–æ–µ–≥–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞).\n' \
                                    f'id –≤–∞—à–µ–π –±–µ—Å–µ–¥—ã = {event.object.peer_id}'
                    else:
                        name = bot_api.users.get(user_id=action["member_id"])
                        otvet = f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @id{event.object.from_id}({name[0]["first_name"]} {name[0]["last_name"]}) –ø—Ä–∏—Å–æ–µ–¥–µ–Ω–∏–ª—Å—è –∫ —á–∞—Ç—É'
                else:
                    name = bot_api.users.get(user_id=action["member_id"])
                    otvet = f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @id{event.object.from_id}({name[0]["first_name"]} {name[0]["last_name"]}) —Å–æ–≤–µ—Ä—à–∏–ª –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ {action["type"]}'
                write_msg(event.object.peer_id, otvet)
            else:
                if event.from_chat:
                    # –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    request = event.object.text.lower()
                    print(request)
                    # –õ–æ–≥–∏–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –±–æ—Ç–∞
                    # –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–∞–∫–∞—è –∫–æ–º–∞–Ω–¥–∞
                    if request[0] == '/':
                        command = str(request.split(' ')[0][1:])
                        if command in commands:
                            print('i know this command')
                            if (command == 'kick' or command == '–∫–∏–∫') and len(request.split(' ')) > 1:
                                if str(request.split(' ')[1][0]) == '[':
                                    #members_request = vk.method('messages.getConversationMembers',
                                    #                            {'peer_id': event.object.peer_id})["response"]["items"]
                                    #users = list()
                                    #for elem in members_request:
                                    #    users.append(elem['member_id'])
                                    # print(users)
                                    kicked_id = int(str(request.split(' ')[1]).split('|')[0][3:])
                                    print(kicked_id)
                                    name = bot_api.users.get(user_id=event.object.from_id)
                                    name2 = bot_api.users.get(user_id=kicked_id)
                                    otvet = f'–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä —á–∞—Ç–∞ @id{event.object.from_id}' \
                                            f'({name[0]["first_name"]} {name[0]["last_name"]})' \
                                            f' –∫–∏–∫–Ω—É–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ' \
                                            f'@id{kicked_id}({name2[0]["first_name"]} {name2[0]["last_name"]}).'
                                    vk.method('messages.removeChatUser',
                                              {'chat_id': event.object.peer_id - 2000000000,
                                               'user_id': kicked_id})
                                else:
                                    otvet = '–ß—Ç–æ–±—ã –∫–∏–∫–Ω—É—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - —É–ø–æ–º—è–Ω–∏—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ "@".\n–ü—Ä–∏–º–µ—Ä: /kick @fedya_nelubin –†–µ–∫–ª–∞–º–∞'
                            if command == 'help' or command == '—Ö–µ–ª–ø':
                                otvet = 'üß¢ –ö–æ–º–∞–Ω–¥—ã, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º: üß¢ \n' \
                                        '/help - –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏.\n' \
                                        '/myid - –í–∞—à –ò–î –í–ö–æ–Ω—Ç–∞–∫—Ç–µ.\n' \
                                        '/mystats - –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ –¥–∞–Ω–Ω–æ–π –±–µ—Å–µ–¥–µ. \n' \
                                        '/stats @–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É–ø–æ–º—è–Ω—É—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –¥–∞–Ω–Ω–æ–π –±–µ—Å–µ–¥–µ.\n' \
                                        '/staff - —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.\n\n' \
                                        'üé© –ö–æ–º–∞–Ω–¥—ã, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—É: üé©\n' \
                                        '/mute @–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω—É—Ç] [–ø—Ä–∏—á–∏–Ω–∞] - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–≥—Ä–æ–∫—É –∑–∞–≥–ª—É—à–∫—É.\n' \
                                        '/unmute @–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - —Å–Ω—è—Ç—å –∏–≥—Ä–æ–∫—É –∑–∞–≥–ª—É—à–∫—É.'
                            if command == 'myid' or command == '–º–æ–π–∏–¥':
                                name = bot_api.users.get(user_id=event.object.from_id)
                                otvet = f'@id{event.object.from_id}({name[0]["first_name"]} {name[0]["last_name"]}), –í–∞—à id - {event.object.from_id}'
                        else:
                            otvet = '–Ø –Ω–µ –∑–Ω–∞—é —Ç–∞–∫–æ–π –∫–æ–º–∞–Ω–¥—ã. –£–∑–Ω–∞—Ç—å –≤—Å–µ –º–æ–∏ –∫–æ–º–∞–Ω–¥—ã - /help, /—Ö–µ–ª–ø, /info, /–∏–Ω—Ñ–æ.'
                    else:
                        print(True)
                        if request in [*answers]:
                            otvet = answers[request]
                        elif request == '–∫—É':
                            print(True)
                            name = bot_api.users.get(user_id=event.object.from_id)
                            otvet = f'–ü—Ä–∏–≤–µ—Ç, @id{event.object.from_id}({name[0]["first_name"]})'
                        else:
                            otvet = '–Ø –æ—Ç–≤–µ—á–∞—é —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–≤–æ–∏ –∫–æ–º–∞–Ω–¥—ã. –ü–æ–¥—Ä–æ–±–Ω–µ–µ - /help .'

                    if otvet != '':
                        write_msg(event.object.peer_id, otvet)
                        otvet = ''
                else:
                    write_msg(event.object.peer_id, '—á—Ç–æ–±—ã —è —Ä–∞–±–æ—Ç–∞–ª –¥–æ–±–∞–≤—å—Ç–µ –º–µ–Ω—è –≤ –±–µ—Å–µ–¥—É')

    except requests.exceptions.ReadTimeout as timeout:
        continue
